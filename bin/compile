#!/bin/sh

indent() {
  sed -u 's/^/       /'
}

move(){
  if [ -d $LIB_DIR ]; then
    cd $LIB_DIR
    mv build/include $VENDOR_DIR
    mv build/lib $VENDOR_DIR
    mv build/share $VENDOR_DIR
    cd $BUILD_DIR
  fi
}

echo "Installing gmplib"

BUILD_DIR=$1
LIB_DIR=$BUILD_DIR/gmplib
VENDOR_DIR=/app/.heroku/vendor
DOWNLOAD_URL="https://gmplib.org/download/gmp/gmp-6.1.0.tar.xz"

echo "DOWNLOAD_URL = " $DOWNLOAD_URL | indent

cd $BUILD_DIR
mkdir -p $LIB_DIR
cd $LIB_DIR
curl -L --silent $DOWNLOAD_URL
tar xf gmp-6.1.0.tar.xz
cd gmp-6.1.0
./configure --prefix=$VENDOR_DIR
make
make install
cd $BUILD_DIR

echo "Installing libnettle"
LIB_DIR=$BUILD_DIR/libnettle
DOWNLOAD_URL="https://ftp.gnu.org/gnu/nettle/nettle-3.1.tar.gz"
mkdir $PREFIX_DIR


mkdir $LIB_DIR
curl -L --silent $DOWNLOAD_URL
tar xf nettle-3.1.tar.gz
cd nettle-3.1
./configure --prefix=$PREFIX_DIR --disable-static
make
make install &&
chmod   -v   755 /usr/lib/lib{hogweed,nettle}.so &&
install -v -m755 -d /usr/share/doc/nettle-3.1 &&
install -v -m644 nettle.html /usr/share/doc/nettle-3.1
cd $BUILD_DIR

echo "Installing gnults"
LIB_DIR=$BUILD_DIR/gnults
DOWNLOAD_URL="https://ftp.gnu.org/gnu/gnutls/gnutls-3.1.5.tar.xz"

mkdir $LIB_DIR
curl -L --silent $DOWNLOAD_URL
tar xf gnutls-3.1.5.tar.xz
cd gnutls-3.1.5
./configure --prefix=$VENDOR_DIR
make
make install
cd $BUILD_DIR

echo "Installing ffmpeg"
LIB_DIR=$BUILD_DIR/ffmepg
DOWNLOAD_URL="http://johnvansickle.com/ffmpeg/releases/ffmpeg-release-32bit-static.tar.xz"

mkdir $LIB_DIR
curl -L --silent $DOWNLOAD_URL
tar xf ffmpeg-release-32bit-static.tar.xz
cd ffmpeg-release-32bit-static
PATH="$HOME/bin:$PATH" PKG_CONFIG_PATH="$HOME/ffmpeg_build/lib/pkgconfig" ./configure \
  --prefix="$VENDOR_DIR \
  --pkg-config-flags="--static" \
  --extra-cflags="-I$HOME/ffmpeg_build/include" \
  --extra-ldflags="-L$HOME/ffmpeg_build/lib" \
  --bindir="$HOME/bin" \
  --enable-gpl \
  --enable-libass \
  --enable-libfdk-aac \
  --enable-libfreetype \
  --enable-libmp3lame \
  --enable-libopus \
  --enable-libtheora \
  --enable-libvorbis \
  --enable-libvpx \
  --enable-libx264 \
  --enable-libx265 \
  --enable-nonfree \
  --enable-gnutls
PATH="$HOME/bin:$PATH" make
make install
make distclean
cd $BUILD_DIR
