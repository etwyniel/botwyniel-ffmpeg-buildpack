#!/bin/sh

BUILD_DIR=$1
mkdir $BUILD_DIR
echo $BUILD_DIR
VENDOR_DIR=/app/.heroku/vendor
mkdir $VENDOR_DIR/include
mkdir $VENDOR_DIR/share/info
LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$VENDOR_DIR/lib

echo "Installing ffmpeg"
LIB_DIR=$BUILD_DIR/ffmpeg
MAKE_DIR=$LIB_DIR/ffmpeg-3.0.2
DOWNLOAD_URL="http://johnvansickle.com/ffmpeg/release-source/ffmpeg-3.0.2.tar.xz"

mkdir $LIB_DIR
cd $LIB_DIR
wget $DOWNLOAD_URL
tar xf ffmpeg-3.0.2.tar.xz
cd ffmpeg-3.0.2
PKG_CONFIG_PATH="$VENDOR_DIR/lib/pkgconfig" ./configure \
  --prefix=$VENDOR_DIR \
  --pkg-config-flags="--static" \
  --extra-cflags="-I$VENDOR_DIR/include" \
  --extra-ldflags="-L$VENDOR_DIR/lib" \
  --bindir="$VENDOR_DIR/bin" \
  --enable-libopus \
  --enable-nonfree \
  --enable-openssl \
  --disable-yasm
make
make install
make distclean
cd $BUILD_DIR
